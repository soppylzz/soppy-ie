name: 🗑️ Delete

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  delete_merged_branches:
    runs-on: ubuntu-latest
    steps:
      - name: set up bot git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: fetch all branches
        run: git fetch --prune --all

      - name: delete merged branches
        run: |
          protected_branches="main"
          allowed_prefixes="old/ new/ site/"
          REPORT_FILE="deleted-branches-report.md"
          
          echo "# 🧹 Deleted Merged Branches Report" > $REPORT_FILE
          echo "_Auto-generated on $(date)_\n" >> $REPORT_FILE
          
          git branch -r --merged origin/main | grep -vE "->" | while read remote; do
            branch=$(echo $remote | sed 's|origin/||')

            if [[ "$protected_branches" =~ (^|[[:space:]])"$branch"($|[[:space:]]) ]]; then
              echo "Skipping protected branch: $branch"
              continue
            fi

            match_prefix=false
            for prefix in $allowed_prefixes; do
              if [[ "$branch" == $prefix* ]]; then
                match_prefix=true
                break
              fi
            done

            if [ "$match_prefix" = false ]; then
              echo "Skipping non-matching branch: $branch"
              continue
            fi

            echo "Deleting branch: $branch"
            git push origin --delete "$branch"
            echo "- \`$branch\`" >> $REPORT_FILE
          done

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: upload deletion report
        uses: actions/upload-artifact@v4
        with:
          name: deleted-branches-report
          path: deleted-branches-report.md